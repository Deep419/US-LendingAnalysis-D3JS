<!DOCTYPE html>
<meta charset="utf-8">

<div id="tooltip-container"></div>

<div id="canvas-svg"></div>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

    $(document).ready(function () {
        loadDashboard()
    });

    var dataset;
    var state_name_map = {};
    var usdata;
    var mydata;
    var COLOR_COUNTS = 9;
    var COLOR_FIRST = "#d8f7fa",
        COLOR_LAST = "#1B4F72";
    var rgb = hexToRgb(COLOR_FIRST);
    var COLOR_START = new Color(rgb.r, rgb.g, rgb.b);
    rgb = hexToRgb(COLOR_LAST);
    var COLOR_END = new Color(rgb.r, rgb.g, rgb.b);
    var startColors = COLOR_START.getColors(),
        endColors = COLOR_END.getColors();
    var colors = [];
    for (var i = 0; i < COLOR_COUNTS; i++) {
        var r = Interpolate(startColors.r, endColors.r, COLOR_COUNTS, i);
        var g = Interpolate(startColors.g, endColors.g, COLOR_COUNTS, i);
        var b = Interpolate(startColors.b, endColors.b, COLOR_COUNTS, i);
        colors.push(new Color(r, g, b));
    }

    var quantize = d3.scaleQuantize()
        .domain([0, 500000])
        .range(d3.range(COLOR_COUNTS).map(function (i) {
            return i
        }));



    function loadDashboard() {

        d3.csv("https://raw.githubusercontent.com/Deep419/va_fall2018/master/Data/joined_data_with_state_codes_updated.csv?token=Apgl-qVudnYLerCt6V2U-AljmQ5Kqe3Qks5cDeruwA%3D%3D", function (error, data) {
            if (error) throw error;
            dataset = data;
            console.log(dataset);

            d3.tsv("https://raw.githubusercontent.com/KuldeepSinh24/VA-HomeWork4/master/Data/us-states.tsv", function (error, state_names) {

                for (var i = 0; i < state_names.length; i++) {
                    state_name_map[state_names[i].id] = state_names[i].code;
                }

                d3.json("https://raw.githubusercontent.com/KuldeepSinh24/VA-HomeWork4/master/Data/us-10m.json", function (error, us) {
                    usdata = us
                    if (error) throw error;
                    createBarChart();
                    createMap();
                    createPropertUseTypeChart();
                    createProductLoanTypeChart();
                    createBestOfferStatus();
                    document.getElementById("defaultOpen").click();
                });
            });
        });
    }

    function createBarChart(state_name = "") {

        $('#bar_chart').empty();

        var svg = d3.select("#bar_chart"),
            margin = {
                top: 10,
                right: 10,
                bottom: 30,
                left: 40
            },
            width = 400 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");

        var x = d3.scaleBand().range([margin.left, width - margin.right]);
        var y = d3.scaleLinear().range([height - margin.bottom, margin.top]);

        var g = svg.append("g")
            .attr("transform", "translate(" +0 + "," + margin.top + ")");

        if (state_name == "") {
            $("#state_label").html("All");
            mydata = d3.nest()
                .key(function (d) {
                    return d.Status_updated;
                })
                .rollup(function (d) {
                    return d.length;
                    // return d3.sum(d, function (g) {
                    //     return g.LoanAmount;
                    // });
                })
                .entries(dataset);

        } else {
            $("#state_label").html(state_name);
            mydata = d3.nest()
                .key(function (d) {
                    return d.Status_updated;
                })
                .rollup(function (d) {
                    return d.length;
                    // return d3.sum(d, function (g) {
                    //     return g.LoanAmount;
                    //     });
                })
                .entries(dataset.filter(function (d) {
                    return d.State == state_name;
                }));
        }

        mydata.sort(function (a, b) {
            
            //console.log(b.value - a.value)
            //console.log(b)
            return a.value - b.value;
        });
    
        y.domain([0, d3.max(mydata, function (d) {
            return d.value;
            
        })]);

        x.domain(mydata.map(function (d) {
            //console.log(d.key)
            return d.key;
        })).padding(0.1);

        g.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            //.attr("transform", "translate(0," + height-margin.bottom + ")")
            .call(d3.axisBottom(x).tickSizeOuter(0))
            // .ticks(3).tickFormat(function (d) {
            //    //console.log(d)
            //    return d;
            // }));

        g.append("g")
            .attr("class", "y axis")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y));

        g.selectAll(".bar")
            .data(mydata)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x",function (d) {
                //console.log(d.key)
                return x(d.key);
            } )
            .attr("height", function (d) {
                return y(0)-y(d.value);
            })
            .attr("y", function (d) {
                return y(d.value);
            })
            .attr("width", x.bandwidth())
            .style("fill", function (d) {
                if(d.key=='Accepted'){
                    console.log(d.value)
                    return '#59a14f'
                }
                else if(d.key=='Rejected'){
                    
                    return '#e15759'
                }
                else{
                    return '#bab0ac'
                }
                // var i = quantize(d.value);
                // var color = colors[i].getColors();
                // return "rgb(" + color.r + "," + color.g +
                //     "," + color.b + ")";
            })
            .on("mousemove", function (d) {
                createMap(d.key)
                tooltip
                    .style("left", d3.event.pageX - 50 + "px")
                    .style("top", d3.event.pageY - 70 + "px")
                    .style("display", "inline-block")
                    .html((d.key) + "<br>" + "No Of Records: " + (d.value));
            })
            .on("mouseout", function (d) {
                createMap()
                tooltip.style("display", "none");
            });
    }

    function createMap(damage_name = "") {
        var svg = d3.select("#choropleth_map");
        var path = d3.geoPath();
        var SCALE = 0.7;


        if (damage_name == "") {
            $("#damage_label").html("All");
            mydata = d3.nest()
                .key(function (d) {
                    return d.StateId;
                })
                .rollup(function (d) {
                    return d3.mean(d, function (g) {
                        return g.LoanAmount;
                    });
                })
                .entries(dataset);
        } else {
            $("#damage_label").html(damage_name);
            mydata = d3.nest()
                .key(function (d) {
                    return d.StateId;
                })
                .rollup(function (d) {
                    return d3.mean(d, function (g) {
                        return g.LoanAmount;
                    });
                })
                .entries(dataset.filter(function (d) {
                    return d.Status == damage_name;
                }));
        }

        name_id_map = {};

        for (var i = 0; i < mydata.length; i++) {

            var dataState = mydata[i].key;
            var dataValue = mydata[i].value;
            name_id_map[dataState] = dataValue;
            for (var j = 0; j < usdata.objects.states.length; j++) {
                var jsonState = usdata.objects.states[j].id;

                if (dataState == jsonState) {
                    usdata.states[j].properties.value = dataValue;
                    break;
                }
            }

        }


        svg.append("g")
            .attr("class", "categories-choropleth")
            .selectAll("path")
            .data(topojson.feature(usdata, usdata.objects.states).features)
            .enter().append("path")
            .attr("d", path)
            .attr("transform", "scale(" + SCALE + ")")
            .style("fill", function (d) {
                var temp = parseInt(d.id, 10)
                if (name_id_map[temp]) {
                    var i = quantize(name_id_map[temp]);
                    var color = colors[i].getColors();
                    return "rgb(" + color.r + "," + color.g +
                        "," + color.b + ")";
                } else {
                    return "";
                }
            })
            .on("mousemove", function (d) {
                createBarChart(state_name_map[parseInt(d.id)])
                createPropertUseTypeChart(state_name_map[parseInt(d.id)]);
                createProductLoanTypeChart(state_name_map[parseInt(d.id)]);

                var html = "";
                var val = name_id_map[parseInt(d.id)];
                html += "<div class=\"tooltip_kv\">";
                html += "<span class=\"tooltip_key\">";
                html += state_name_map[parseInt(d.id)];
                html += " : ";
                html += val;
                html += "</span>";
                html += "</div>";

                $("#tooltip-container").html(html);
                $(this).attr("fill-opacity", "0.8");
                $("#tooltip-container").show();

                var coordinates = d3.mouse(this);

                var map_width = $('.categories-choropleth')[0].getBoundingClientRect().width;

                if (d3.event.pageX < map_width / 2) {
                    d3.select("#tooltip-container")
                        .style("top", (d3.event.pageY + 15) + "px")
                        .style("left", (d3.event.pageX + 15) + "px");
                } else {
                    var tooltip_width = $("#tooltip-container").width();
                    d3.select("#tooltip-container")
                        .style("top", (d3.event.pageY + 15) + "px")
                        .style("left", (d3.event.pageX - tooltip_width - 30) + "px");
                }
            })
            .on("mouseout", function () {
                createBarChart()
                createPropertUseTypeChart();
                createProductLoanTypeChart();
                $(this).attr("fill-opacity", "1.0");
                $("#tooltip-container").hide();
            });

        svg.append("path")
            .datum(topojson.mesh(usdata, usdata.objects.states, function (a, b) {
                return a !== b;
            }))
            .attr("class", "categories")
            .attr("transform", "scale(" + SCALE + ")")
            .attr("d", path);


    }

    function Interpolate(start, end, steps, count) {
        var s = start,
            e = end,
            final = s + (((e - s) / steps) * count);
        return Math.floor(final);
    }

    function Color(_r, _g, _b) {
        var r, g, b;
        var setColors = function (_r, _g, _b) {
            r = _r;
            g = _g;
            b = _b;
        };

        setColors(_r, _g, _b);
        this.getColors = function () {
            var colors = {
                r: r,
                g: g,
                b: b
            };
            return colors;
        };
    }

    function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }
    // Create Property Use Type Distribution
    function createPropertUseTypeChart(state_name = "") {

        $('#property_id_bar_chart').empty();

        var svg = d3.select("#property_id_bar_chart"),
            margin = {
                top: 10,
                right: 10,
                bottom: 30,
                left: 40
            },
            width = 400 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");

        var x = d3.scaleBand().range([margin.left, width - margin.right]);
        var y = d3.scaleLinear().range([height - margin.bottom, margin.top]);

        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        if (state_name == "") {
            $("#state_label").html("All");
            mydata = d3.nest()
                .key(function (d) {
                    if (d.PropertyTypeId == 1) {
                        return "Single Family"
                    } else if (d.PropertyTypeId == 6) {
                        return "Mobile/Manufacture"
                    } else {
                        return "Other"
                    }
                })
                .rollup(function (d) {
                    return d.length;
                })
                .entries(dataset);

        } else {
            $("#state_label").html(state_name);
            mydata = d3.nest()
                .key(function (d) {
                    if (d.PropertyTypeId == 1) {
                        return "Single Family"
                    } else if (d.PropertyTypeId == 6) {
                        return "Mobile/Manufacture"
                    } else {
                        return "Other"
                    }
                })
                .rollup(function (d) {
                    return d.length;
                })
                .entries(dataset.filter(function (d) {
                    return d.State == state_name;
                }));
        }

        mydata.sort(function (a, b) {
            return a.value - b.value;
        });

        y.domain([0, d3.max(mydata, function (d) {
            return d.value;
        })]);

        x.domain(mydata.map(function (d) {
            //console.log(d.key)
            return d.key;
        })).padding(0.1);

        g.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x))
            // .ticks(5).tickFormat(function (d) {
            //     return parseInt(d / 1000);
            // }).tickSizeInner([-height]));

        g.append("g")
            .attr("class", "y axis")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y));

        g.selectAll(".bar")
            .data(mydata)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function (d) {
                return x(d.key);
            } )
            .attr("height", function (d) {
                return y(0)-y(d.value);
            })
            .attr("y", function (d) {
                return y(d.value);
            })
            .attr("width", x.bandwidth())
            .style("fill", function (d) {
                if(d.key=='Single Family'){
                    //console.log(d.value)
                    return '#f28e2b'
                }
                else if(d.key=='Mobile/Manufacture'){
                    return '#e15759'
                }
                else{
                    return '#4e79a7'
                }
                // var i = quantize(d.value);
                // var color = colors[i].getColors();
                // return "rgb(" + color.r + "," + color.g +
                //     "," + color.b + ")";
            })
            .on("mousemove", function (d) {
                createMap(d.key)
                tooltip
                    .style("left", d3.event.pageX - 50 + "px")
                    .style("top", d3.event.pageY - 70 + "px")
                    .style("display", "inline-block")
                    .html((d.key) + "<br>" + "No Of Records: " + (d.value));
            })
            .on("mouseout", function (d) {
                createMap()
                tooltip.style("display", "none");
            });
    }
    // Create Loan Product Type Distribution
    function createProductLoanTypeChart(state_name = "") {

        $('#product_loan_bar_chart').empty();

        var svg = d3.select("#product_loan_bar_chart"),
        margin = {
                top: 10,
                right: 10,
                bottom: 30,
                left: 40
            },
            width = 400 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");

        var x = d3.scaleBand().range([margin.left, width - margin.right]);
        var y = d3.scaleLinear().range([height - margin.bottom, margin.top]);

        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        if (state_name == "") {
            $("#state_label").html("All");
            mydata = d3.nest()
                .key(function (d) {
                    if (d.LoanProductName == '15YearFixed') { return '15 Yr Fixed'; }
                    else if (d.LoanProductName == 'VA 15 Yr Fixed') {
                        return '15 Yr Fixed';
                    }
                    else if (d.LoanProductName == '30YearFixed') { return '30 Yr Fixed'; }
                    else if (d.LoanProductName == 'VA 30 Yr Fixed') { return '30 Yr Fixed'; }
                    else if (d.LoanProductName == '5/1 ARM') { return '5 Yr ARM'; }
                    else if (d.LoanProductName == '5YearARM') { return '5 Yr ARM'; }
                    else if (d.LoanProductName == 'FNMA 5/1 ARM') { return 'FNMA 5 Yr ARM'; }
                    else if (d.LoanProductName == 'VA 5 Yr ARM') { return '5 Yr ARM'; }
                    else if (d.LoanProductName == '7/1 ARM') { return '7 Yr ARM'; }
                    else if (d.LoanProductName == 'FNMA 7/1 ARM') { return 'FNMA 7 Yr ARM'; }
                    else { return d.LoanProductName; }
                })
                .rollup(function (d) {
                    return d.length;
                })
                .entries(dataset);

        } else {
            $("#state_label").html(state_name);
            mydata = d3.nest()
                .key(function (d) {
                    if (d.LoanProductName == '15YearFixed') { return '15 Yr Fixed'; }
                    else if (d.LoanProductName == 'VA 15 Yr Fixed') {
                        return '15 Yr Fixed';
                    }
                    else if (d.LoanProductName == '30YearFixed') { return '30 Yr Fixed'; }
                    else if (d.LoanProductName == 'VA 30 Yr Fixed') { return '30 Yr Fixed'; }
                    else if (d.LoanProductName == '5/1 ARM') { return '5 Yr ARM'; }
                    else if (d.LoanProductName == '5YearARM') { return '5 Yr ARM'; }
                    else if (d.LoanProductName == 'FNMA 5/1 ARM') { return 'FNMA 5 Yr ARM'; }
                    else if (d.LoanProductName == 'VA 5 Yr ARM') { return '5 Yr ARM'; }
                    else if (d.LoanProductName == '7/1 ARM') { return '7 Yr ARM'; }
                    else if (d.LoanProductName == 'FNMA 7/1 ARM') { return 'FNMA 7 Yr ARM'; }
                    else { return d.LoanProductName; }
                })
                .rollup(function (d) {
                    return d.length;
                })
                .entries(dataset.filter(function (d) {
                    return d.State == state_name;
                }));
        }

        mydata.sort(function (a, b) {
            return a.value - b.value;
        });

        y.domain([0, d3.max(mydata, function (d) {
            return d.value;
        })]);

        x.domain(mydata.map(function (d) {
            return d.key;
        })).padding(0.1);

        g.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
    .attr("y", 0)
    .attr("x", 9)
    .attr("dy", ".35em")
    .attr("transform", "rotate(90)")
    .style("text-anchor", "start");
            // .ticks(5).tickFormat(function (d) {
            //     return parseInt(d / 1000);
            // }).tickSizeInner([-height]));

        g.append("g")
            .attr("class", "y axis")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y));

        g.selectAll(".bar")
            .data(mydata)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function (d) {
                return x(d.key);
            } )
            .attr("height", function (d) {
                return y(0)-y(d.value);
            })
            .attr("y", function (d) {
                return y(d.value);
            })
            .attr("width", x.bandwidth())
            .style("fill", function (d) {
                return '#4e79a7';
            })
            .on("mousemove", function (d) {
                createMap(d.key)
                tooltip
                    .style("left", d3.event.pageX - 50 + "px")
                    .style("top", d3.event.pageY - 70 + "px")
                    .style("display", "inline-block")
                    .html((d.key) + "<br>" + "No Of Records: " + (d.value));
            })
            .on("mouseout", function (d) {
                createMap()
                tooltip.style("display", "none");
            });
    }
    // Create Loan Product Type Distribution
    function createBestOfferStatus(state_name = "") {

        $('#is_bestOffer_bar_chart').empty();

        var svg = d3.select("#is_bestOffer_bar_chart"),
            margin = {
                top: 10,
                right: 10,
                bottom: 30,
                left: 40
            },
            width = 400 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");

        var x = d3.scaleBand().range([margin.left, width - margin.right]);
        var y = d3.scaleLinear().range([height - margin.bottom, margin.top]);

        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        if (state_name == "") {
            $("#state_label").html("All");
            mydata = d3.nest()
                .key(function (d) {
                    return d.IsBestOffer;
                })
                .rollup(function (d) {
                    return d.length;
                })
                .entries(dataset);

        } else {
            $("#state_label").html(state_name);
            mydata = d3.nest()
                .key(function (d) {
                    return d.IsBestOffer;
                })
                .rollup(function (d) {
                    return d.length;
                })
                .entries(dataset.filter(function (d) {
                    return d.State == state_name;
                }));
        }

        mydata.sort(function (a, b) {
            return a.value - b.value;
        });

        y.domain([0, d3.max(mydata, function (d) {
            return d.value;
        })]);

        x.domain(mydata.map(function (d) {
            return d.key;
        })).padding(0.1);

        g.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x))
            //.ticks(5).tickFormat(function (d) {
            //     return parseInt(d / 1000);
            // }).tickSizeInner([-height]));

        g.append("g")
            .attr("class", "y axis")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y));
            

        g.selectAll(".bar")
            .data(mydata)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x",function (d) {
                return x(d.key);
            } )
            .attr("height", function (d) {
                return y(0)-y(d.value);
            })
            .attr("y", function (d) {
                return y(d.value);
            })
            .attr("width", x.bandwidth())
            .style("fill", function (d) {
                if(d.key=='TRUE'){
                    //console.log(d.value)
                    return '#59a14f'
                }
                else if(d.key=='FALSE'){
                    return '#e15759'
                }
                
            })
            .on("mousemove", function (d) {
                createMap(d.key)
                tooltip
                    .style("left", d3.event.pageX - 50 + "px")
                    .style("top", d3.event.pageY - 70 + "px")
                    .style("display", "inline-block")
                    .html((d.key) + "<br>" + "No Of Records: " + (d.value));
            })
            .on("mouseout", function (d) {
                createMap()
                tooltip.style("display", "none");
            });
    }
    //Function that opens tabs
    function openTab(evt, cityName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(cityName).style.display = "block";
        evt.currentTarget.className += " active";
    }

</script>

<body>
    <table align="center">
        <tr>
            <td>
                <h2 id="choropleth" align="center">Choropleth Map</h2>
                <h2>Offer Status 2015 [$] Damage Type:
                    <span id="damage_label">All</span>
                </h2>
                <svg width="800" height="700" id="choropleth_map"></svg>
            </td>
            <td>
                <div class="tab">
                        <button class="tablinks" onclick="openTab(event, 'First')" id="defaultOpen">First</button>
                        <button class="tablinks" onclick="openTab(event, 'Second')">Second</button>
                        <button class="tablinks" onclick="openTab(event, 'Third')">Third</button>
                        <button class="tablinks" onclick="openTab(event, 'Fourth')">Fourth</button>
                    </div>
                    
                    <!-- Tab content -->
                    <div id="First" class="tabcontent">
                        <h2 id="barchart" align="center">Bar Chart</h2>
                        <h2>Losses 2015 [$] State:
                        <span id="state_label">All</span>
                        </h2>
                        <svg width="400" height="700" id="bar_chart"></svg>
                    </div>
                    <div id="Second" class="tabcontent">
                        <h2 id="choropleth" align="center">Product Loan Type</h2>
                        <h2>Product Loan Type:
                        <span id="damage_label">All</span>
                        </h2>
                        <svg width="500" height="700" id="product_loan_bar_chart"></svg>
                    </div>

                    <div id="Third" class="tabcontent">
                        <h2 id="barchart" align="center">Property Use Type Bar Chart</h2>
                        <h2>Property Use Type [$] State:
                            <span id="state_label">All</span>
                        </h2>
                        <svg width="500" height="700" id="property_id_bar_chart"></svg>
                    </div>

                    <div id="Fourth" class="tabcontent">
                        <h2 id="barchart" align="center">Property Use Type Bar Chart</h2>
                        <h2>Property Use Type [$] State:
                            <span id="state_label">All</span>
                        </h2>
                        <svg width="500" height="700" id="is_bestOffer_bar_chart"></svg>
                    </div>
            </td>
        </tr>
    </table>
    <div id="tooltip-container"></div>
</body>